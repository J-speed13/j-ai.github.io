<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J-AI | Neural Core</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js'></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono&family=Inter:wght@400;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0b0f19; color: #e2e8f0; margin: 0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .message-anim { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .render-container { border: 1px solid #3b82f6; border-radius: 12px; overflow: hidden; margin-top: 10px; background: #000; box-shadow: 0 0 20px rgba(59, 130, 246, 0.15); }
        .render-image { width: 100%; height: auto; display: block; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-slate-900 border-b border-slate-800 p-4 flex items-center justify-between shadow-2xl">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-blue-600 to-cyan-400 flex items-center justify-center shadow-lg shadow-cyan-500/20">
                <span class="text-white font-bold text-xl">J</span>
            </div>
            <div>
                <h1 class="font-bold text-white tracking-tight">J-AI</h1>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-[10px] text-slate-500 font-mono uppercase tracking-widest">Online</span>
                </div>
            </div>
        </div>
        <button onclick="window.location.reload()" class="text-slate-500 hover:text-white transition-colors"><i class="fas fa-redo"></i></button>
    </header>

    <main id="chat-box" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
        <div class="message-anim flex items-start space-x-3">
            <div class="w-8 h-8 rounded-lg bg-blue-600 flex-shrink-0 flex items-center justify-center text-white font-bold text-xs shadow-md">J</div>
            <div class="bg-slate-800/50 border border-slate-700/50 p-4 rounded-2xl rounded-tl-none text-sm text-slate-200 max-w-[85%] backdrop-blur-sm shadow-xl">
                System Initialized. I am **J-AI**. 
                <br><br>
                Canvas disabled. Running on direct neural bridge.
            </div>
        </div>
    </main>

    <div id="typing-indicator" class="hidden px-14 py-2 text-cyan-400 text-[10px] font-mono animate-pulse uppercase tracking-widest">
        J-AI is thinking...
    </div>

    <footer class="bg-slate-900 border-t border-slate-800">
        <!-- Attachment Staging Area -->
        <div id="attachment-preview" class="hidden px-4 py-2 border-b border-slate-800 bg-slate-900/50 flex items-center gap-3">
            <div class="relative">
                <img id="preview-img" class="h-16 w-16 object-cover rounded-lg border border-slate-600 shadow-md">
                <button id="remove-attachment" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-600 transition-colors shadow-sm">Ã—</button>
            </div>
            <div class="flex flex-col">
                <span class="text-xs text-white font-semibold">Image Attached</span>
                <span class="text-[10px] text-slate-400 font-mono">Ready to scan or analyze with text.</span>
            </div>
        </div>

        <div class="p-4 max-w-4xl mx-auto flex items-center gap-3">
            <label class="cursor-pointer bg-slate-800 hover:bg-slate-700 text-slate-400 p-3 rounded-xl border border-slate-700 transition-all flex items-center justify-center w-12 h-12 shadow-lg">
                <i class="fas fa-paperclip"></i>
                <input type="file" id="file-input" class="hidden" accept="image/*">
            </label>
            <input type="text" id="user-in" class="flex-1 bg-slate-950 border border-slate-700 rounded-xl px-5 py-3 text-white outline-none focus:border-cyan-500 font-mono text-sm transition-all" placeholder="Ask J-AI or say 'Draw a cat'...">
            <button id="exec-btn" class="bg-blue-600 hover:bg-blue-500 text-white w-12 h-12 rounded-xl flex items-center justify-center transition-all active:scale-90 shadow-lg">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </footer>

    <script>
        const chatBox = document.getElementById('chat-box');
        const userIn = document.getElementById('user-in');
        const execBtn = document.getElementById('exec-btn');
        const typing = document.getElementById('typing-indicator');
        const fileInput = document.getElementById('file-input');
        const attachmentPreview = document.getElementById('attachment-preview');
        const previewImg = document.getElementById('preview-img');
        const removeAttachmentBtn = document.getElementById('remove-attachment');

        let stagedImage = null;

        async function processJAI() {
            const input = userIn.value.trim();
            if (!input && !stagedImage) return;

            // UI: Post user message
            postUserMessage(input, stagedImage);
            
            // Capture state for processing
            const processingImage = stagedImage;
            const query = input.toLowerCase();

            // Clear Inputs
            userIn.value = '';
            stagedImage = null;
            attachmentPreview.classList.add('hidden');
            
            typing.classList.remove('hidden');

            // 1. Process Image Attachment (OCR) if present
            let contextText = "";
            if (processingImage) {
                try {
                    const result = await Tesseract.recognize(processingImage, 'eng');
                    const extractedText = result.data.text.trim();
                    if (extractedText) {
                        contextText = ` [System Note: The user attached an image containing this text: "${extractedText}"]`;
                        // Optionally inform user OCR worked
                        // postMessage(`**OCR Info:** Read ${extractedText.length} characters from image.`, 'ai'); 
                    } else {
                        contextText = ` [System Note: The user attached an image, but no text was detected.]`;
                    }
                } catch (e) {
                    console.error("OCR Failed");
                }
            }

            // 2. Logic: Is it a drawing request?
            const drawingTriggers = ['draw', 'generate', 'create', 'image', 'picture', 'painting'];
            const isDrawing = drawingTriggers.some(word => query.includes(word)) && !processingImage;

            if (isDrawing) {
                // Generate Image
                const seed = Math.floor(Math.random() * 1000000);
                const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(input)}?width=1024&height=1024&nologo=true&seed=${seed}`;
                
                setTimeout(() => {
                    postImage(imgUrl);
                    typing.classList.add('hidden');
                }, 500);
            } else {
                // Generate Text Response (with image context if available)
                try {
                    const fullPrompt = input + contextText;
                    const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(fullPrompt)}?system=You are J-AI, a helpful AI created by Jasper. You are fast and accurate. Never mention Google or Gemini.`);
                    const data = await res.text();
                    postMessage(data, 'ai');
                } catch (e) {
                    postMessage("Neural connection flickered. Please try that again.", 'ai');
                }
                typing.classList.add('hidden');
            }
        }

        function postMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `message-anim flex items-start space-x-3 ${sender === 'user' ? 'flex-row-reverse space-x-reverse' : ''}`;
            const bubbleClass = sender === 'ai' ? 'bg-slate-800 border-slate-700' : 'bg-blue-700 border-blue-600';
            const icon = sender === 'ai' ? 'J' : 'U';
            const iconBg = sender === 'ai' ? 'bg-blue-600' : 'bg-slate-700';

            div.innerHTML = `
                <div class="w-8 h-8 rounded-lg ${iconBg} flex-shrink-0 flex items-center justify-center text-white font-bold text-xs shadow-md">${icon}</div>
                <div class="${bubbleClass} border p-4 rounded-2xl text-sm text-white max-w-[85%] leading-relaxed shadow-xl">
                    ${text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}
                </div>
            `;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function postUserMessage(text, imageSrc) {
            const div = document.createElement('div');
            div.className = `message-anim flex items-start space-x-3 flex-row-reverse space-x-reverse`;
            
            let contentHtml = '';
            if (imageSrc) {
                contentHtml += `<img src="${imageSrc}" class="rounded-lg max-h-48 mb-2 border border-blue-500/30">`;
            }
            if (text) {
                contentHtml += `<span>${text.replace(/\n/g, '<br>')}</span>`;
            }

            div.innerHTML = `
                <div class="w-8 h-8 rounded-lg bg-slate-700 flex-shrink-0 flex items-center justify-center text-white font-bold text-xs shadow-md">U</div>
                <div class="bg-blue-700 border-blue-600 border p-4 rounded-2xl text-sm text-white max-w-[85%] leading-relaxed shadow-xl flex flex-col items-end">
                    ${contentHtml}
                </div>
            `;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function postImage(url) {
            const div = document.createElement('div');
            div.className = "message-anim flex items-start space-x-3";
            div.innerHTML = `
                <div class="w-8 h-8 rounded-lg bg-blue-600 flex-shrink-0 flex items-center justify-center text-white font-bold text-xs">J</div>
                <div class="bg-slate-800 border border-slate-700 p-2 rounded-2xl max-w-[85%] shadow-xl">
                    <div class="render-container">
                        <img src="${url}" class="render-image" alt="J-AI Image">
                    </div>
                    <p class="mt-2 text-[10px] text-slate-500 font-mono uppercase text-center">J-AI Neural Render Complete</p>
                </div>
            `;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- ATTACHMENT HANDLER ---
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                stagedImage = event.target.result;
                previewImg.src = stagedImage;
                attachmentPreview.classList.remove('hidden');
                userIn.focus();
            };
            reader.readAsDataURL(file);
            fileInput.value = ''; // Reset for re-selection
        });

        removeAttachmentBtn.addEventListener('click', () => {
            stagedImage = null;
            attachmentPreview.classList.add('hidden');
        });

        execBtn.addEventListener('click', processJAI);
        userIn.addEventListener('keypress', (e) => { if(e.key === 'Enter') processJAI(); });
    </script>
</body>
</html>